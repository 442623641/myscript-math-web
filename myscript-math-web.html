<!--
Copyright Â© MyScript.
LICENSE: [Apache License 2.0](http://www.apache.org/licenses/LICENSE-2.0)
-->
<link rel="import" href="../polymer/polymer.html">
<script src="../KaTeX/dist/katex.min.js"></script>
<link rel="import" href="../myscript-common-element/myscript-common-element.html">
<!--
The `myscript-math-web` is a turnkey solution for those who need to quickly implement MyScript Math recognition.

    <myscript-math-web
        applicationkey="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"
        hmackey="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX">
    </myscript-math-web>

@demo
-->
<dom-module id="myscript-math-web">
    <link rel="stylesheet" href="../KaTeX/dist/katex.min.css">
    <style>
        :host {
            display: block;
        }
        myscript-common-element {
            height: 100%;
        }
        myscript-common-element.result {
            height: calc(100% - 100px);
        }
        .resultField {
            overflow: auto;
            text-align: center;
            min-height: 100px;
            max-height: 100px;
        }
    </style>
    <template>
        <div id="resultField" class="resultField" hidden="[[ hideresult ]]"></div>
        <myscript-common-element host="[[ host ]]"
                                 protocol="[[ protocol ]]"
                                 type="MATH"
                                 applicationkey="[[ applicationkey ]]"
                                 hmackey="[[ hmackey ]]"
                                 timeout="[[ timeout ]]"
                                 hidebuttons="[[ hidebuttons ]]"
                                 mathparameters="[[ _mathParameters ]]"
                                 canundo="{{ canundo }}"
                                 canredo="{{ canredo }}"
                                 canclear="{{ canclear }}"
                                 on-changed="_onChanged"
                                 on-success="_onSuccess"
                                 on-error="_onError">
        </myscript-common-element>
    </template>
</dom-module>

<script>
    Polymer({
        is: 'myscript-math-web',
        /**
         * Fired when a math recognition result is successfully received.
         *
         * @event myscript-math-web-result
         */
        /**
         * Fired when the delete action is done.
         *
         * @event myscript-math-web-delete
         */
        /**
         * Fired when a recognition error occurred.
         * @event error
         */
        /**
         * Fired when the content of the myscript-math-web changes.
         * @event changed
         */
        properties: {
            /**
             * The current recognition protocol (WebSocket or REST). We strongly recommend using WebSocket.
             * @default 'WebSocket'
             */
            protocol: {
                type: String,
                value: MyScript.Protocol.WS
            },
            /**
             * The current recognition service host.
             */
            host: {
                type: String,
                value: 'cloud.myscript.com'
            },
            /**
             * The recognition timeout, only use for HTTP.
             */
            timeout: {
                type: Number,
                value: 2000
            },
            /**
             * Application key to use for recognition on MyScript handwriting recognition server.<br />
             * You have to create your own MyScript Developer account at http://dev.myscript.com and then generate your application key at http://cloud.myscript.com. See the Developer Guide to learn how to register.<br /><br />
             * <b>Warning</b>: This parameter is <b>mandatory</b> and its value should be a string.
             */
            applicationkey: {
                type: String
            },
            /**
             * HMAC key to use for recognition on MyScript handwriting recognition server.<br />
             * You have to create your own HMAC key corresponding to your own application key in your account at http://cloud.myscript.com.<br /><br />
             * <b>Warning</b>: This parameter may be <b>mandatory</b> if HMAC signature security is enabled for your application. The value should be a string.
             */
            hmackey: {
                type: String
            },
            /**
             * @private
             */
            canundo: {
                type: Boolean,
                notify: true,
                value: false
            },
            /**
             * @private
             */
            canredo: {
                type: Boolean,
                notify: true,
                value: false
            },
            /**
             * @private
             */
            canclear: {
                type: Boolean,
                notify: true,
                value: false
            },
            /**
             * If set to true, hide the buttons (Trash, Undo, Redo).
             */
            hidebuttons: {
                type: Boolean,
                value: false
            },
            /**
             * If set to true, hide the result div tag.
             */
            hideresult: {
                type: Boolean,
                value: false,
                observer: '_hideresultChanged'
            },
            /**
             * Math result types (LATEX, MATHML or SYMBOLTREE).
             */
            resulttypes: {
                type: Array,
                value: []
            },
            _mathParameters: {
                type: Object,
                computed: '_computeMathParameters(resulttypes)'
            },
            /**
             * The math recognition result document.
             * @private
             * @default {}
             */
            mathdocument: {
                type: Object,
                value: new MyScript.MathDocument(),
                notify: true
            },
            /**
             * <b>Deprecated</b>: Use latex or mathml result directly<br />
             */
            result: {
                type: Object,
                notify: true,
                readOnly: true,
                computed: '_computeResult(mathdocument)'
            },
            /**
             * The LaTeX result.
             */
            latex: {
                type: String,
                notify: true,
                readOnly: true,
                computed: '_computeLaTeXResult(result)',
                observer: '_latexChanged'
            },
            /**
             * The MathML result.
             */
            mathml: {
                type: String,
                notify: true,
                readOnly: true,
                computed: '_computeMathMLResult(result)'
            }
        },
        _clear: function () {
            this._myscriptCommonElement.clear();
            this.fire('myscript-math-web-delete');
        },
        _undo: function () {
            this._myscriptCommonElement.undo();
        },
        _redo: function () {
            this._myscriptCommonElement.redo();
        },
        /**
         * Clear the  current document.
         */
        delete: function () {
            this._clear();
        },
        /**
         * Undo the last action.
         */
        undo: function () {
            this._undo();
        },
        /**
         * Redo the last action.
         */
        redo: function () {
            this._redo();
        },
        _onChanged: function (e) {
            this.fire(e.type, e.detail);
        },
        _onSuccess: function (e) {
            if (e.detail && e.detail.getMathDocument) {
                this.mathdocument = e.detail.getMathDocument();
            } else {
                this.mathdocument = new MyScript.MathDocument();
            }
            this.fire(e.type, e.detail);
            this.fire('myscript-math-web-result', e.detail);
        },
        _onError: function (e) {
            this.fire(e.type, e.detail);
        },
        ready: function () {
            this._myscriptCommonElement = this.querySelector('myscript-common-element');
            this._hideresultChanged(this.hideresult);
        },
        _computeMathParameters: function (resulttypes) {
            var parameters = new MyScript.MathParameter();
            parameters.setResultTypes(resulttypes);
            return parameters;
        },
        _computeResult: function (mathDocument) {
            if (mathDocument && mathDocument.getResultElements && (Object.keys(mathDocument.getResultElements()).length > 0)) {
                var result = {};
                for (var i in mathDocument.getResultElements()) {
                    result[mathDocument.getResultElements()[i].getType()] = mathDocument.getResultElements()[i].getValue();
                }
                return result;
            }
            return undefined;
        },
        _computeLaTeXResult: function (result) {
            if (result && result.hasOwnProperty(MyScript.ResultType.Math.LATEX)) {
                return result.LATEX;
            }
            return undefined;
        },
        _computeMathMLResult: function (result) {
            if (result && result.hasOwnProperty(MyScript.ResultType.Math.MATHML)) {
                return result.MATHML;
            }
            return undefined;
        },
        _hideresultChanged: function (hideresult) {
            if (this._myscriptCommonElement) {
                if (hideresult) {
                    this._myscriptCommonElement.classList.remove('result');
                } else {
                    this._myscriptCommonElement.classList.add('result');
                }
            }
        },
        _latexChanged: function (latex) {
            if (this.$.resultField) {
                this.$.resultField.innerHTML = '';
                if (latex) {
                    try {
                        katex.render(latex, this.$.resultField);
                    } catch (e) {
                        this.$.resultField.innerHTML = '<span>Invalid KaTeX mathemathic expression.</span>';
                    }
                } else if (this.result) {
                    this.$.resultField.innerHTML = '<span>No LaTeX mathemathic expression return to the result. Check your resulttypes attribut.</span>';
                }
            }
        }
    });
</script>
