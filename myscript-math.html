<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../myscript-toolbar/myscript-toolbar.html">
<link rel="import" href="../myscript-result/myscript-result.html">
<link rel="import" href="../myscript-stroker/myscript-stroker.html">
<link rel="import" href="../myscript-renderer/myscript-renderer.html">
<link rel="import" href="../myscript-recognizer/myscript-recognizer.html">
<link rel="import" href="../myscript-canvas/myscript-canvas.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <myscript-math url="http://localhost:8888/api/v3.0/recognition/rest" applicationKey="ed45a5b4-946d-45c4-8234-fb840fb6416b" hmacKey="a1789a80-8514-3d17-acd0-cc5d6674acea" type="Math"></myscript-math>

@element myscript-math
@blurb MyScript HTML5 math Element to help developer for integrate handwriting recognition.
@status alpha
@homepage http://polymerlabs.github.io/myscript-math
-->
<polymer-element name="myscript-math" attributes="url applicationKey hmacKey type" on-myscript-toolbar-delete="{{delete}}" on-myscript-toolbar-undo="{{undo}}" on-myscript-toolbar-redo="{{redo}}" on-myscript-toolbar-info="{{info}}">
    <template>
        <link rel="stylesheet" href="./myscript-math.css">
        <core-scaffold>
            <div vertical layout>
                <div>
                    <myscript-result></myscript-result>
                </div>
                <div>
                    <myscript-toolbar delete="true" undo="true" redo="true" info="true"></myscript-toolbar>
                    <myscript-stroker></myscript-stroker>
                    <myscript-renderer type="{{type}}"></myscript-renderer>
                    <myscript-recognizer type="{{type}}" url="{{url}}" applicationKey="{{applicationKey}}" hmacKey="{{hmacKey}}" ></myscript-recognizer>
                    <myscript-canvas on-myscript-canvas-down="{{down}}" on-myscript-canvas-track="{{track}}" on-myscript-canvas-up="{{up}}" on-myscript-canvas-resize="{{redraw}}"></myscript-canvas>
                </div>
            </div>
            <paper-dialog id="infodialog" class="infodialog" backdrop layout fullbleed>
                <div class="fullcontainer" fullbleed flex layout vertical>
                        <h3>About</h3>
                        <p align='justify'>Write an equation in the canvas zone. <br> After a short timeout (a second) the recognition will be launched and the result will be shown at the bottom of the page. <br> You can clear the writing space by clicking on the garbage can icon in the top right corner of the yellow zone.</p>
                    </div>
                </div>
            </paper-dialog>
        </core-scaffold>
    </template>
    <script>
        Polymer({
            result: '',
            toolbar: '',
            stroker: '',
            renderer: '',
            recognizer: '',
            canvas: '',
            rendererParameters: '',
            recognizerParameters: '',
            instanceId: '',
            components: [],
            timer: null,
            delete: function(event){
                this.result.clear();
                this.stroker.clear();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.instanceId ='';
            },
            undo: function(event){
                this.stroker.undo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.stroker.getStrokes(), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
            },
            redo: function(event){
                this.stroker.redo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.stroker.getStrokes(), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
            },
            info: function(event){
                this.$.infodialog.toggle();
            },
            down: function(event){
                if (this.timer) {
                    this.timer.stop();
                }
                this.stroker.startStrokeWriting(event.detail.x, event.detail.y, event.detail.event.timeStamp);
                this.renderer.drawStart(event.detail.x, event.detail.y);
            },
            track: function(event){
                this.stroker.continueStrokeWriting(event.detail.x, event.detail.y, event.detail.event.timeStamp);
                this.renderer.drawContinue(event.detail.x, event.detail.y,  this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
            },
            up: function(event){
                this.stroker.endStrokeWriting();
                this.renderer.drawEnd(event.detail.x, event.detail.y, this.canvas.$.canvas.getContext('2d'), this.rendererParameters);

                this.timer = this.job(this.timer, function() {
                    this.recognizer.doSimpleRecognition(this.applicationKey, this.instanceId, this.components.concat(this.stroker.getStrokes()), this.hmacKey, this.recognizerParameters).then(
                                    function success (response) {
                                        this.result.setResult(JSON.stringify(response));
                                        this.instanceId = response.instanceId;
                                        this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                                        this.renderer.drawRecognitionResult(this.stroker.getStrokes(),  response.result, this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
                                    }.bind(this),
                                    function error (response) {
                                        this.result.setResult(JSON.stringify(response));
                                    }.bind(this)
                            );
                }, 2000);
            },
            redraw: function(){
                if(this.result.getResult() !== ''){
                    this.renderer.drawRecognitionResult(this.stroker.getStrokes(),  new MyScript.MathDocument(JSON.parse(this.result.getResult()).result), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
                }else {
                    this.renderer.drawStrokes(this.stroker.getStrokes(), this.canvas.$.canvas.getContext('2d'), this.rendererParameters);
                }
            },
            ready: function() {

                this.result = this.shadowRoot.querySelector('myscript-result');
                this.toolbar = this.shadowRoot.querySelector('myscript-toolbar');
                this.stroker = this.shadowRoot.querySelector('myscript-stroker');
                this.renderer = this.shadowRoot.querySelector('myscript-renderer');
                this.recognizer = this.shadowRoot.querySelector('myscript-recognizer');
                this.canvas = this.shadowRoot.querySelector('myscript-canvas');

                this.rendererParameters = this.renderer.createRenderingParameter();
                this.recognizerParameters = this.recognizer.createMathParameter();

                this.instanceId = '';
                this.components = [];

                this.recognizerParameters.setResultTypes(['LATEX', 'MATHML', 'SYMBOLTREE']);
            }
        });
    </script>
</polymer-element>