<!--
Copyright Â© MyScript.
LICENSE: github.com/MyScriptWebComponents/myscript-math/blob/master/LICENSE
-->
<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-icons/av-icons.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-toolbar/paper-toolbar.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../myscript-ink-paper/myscript-ink-paper.html">
<link rel="import" href="../myscript-result/myscript-result.html">
<!--
The `myscript-math` is a turnkey solution for those who need to quickly implement MyScript Math recognition.

##### Example

    <myscript-math application-key="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" hmac-key="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"></myscript-math>

@group MyScript Elements
@element myscript-math
@blurb MyScript HTML5 Math Element to help developers integrate math handwriting recognition.
@status alpha
@homepage http://myscriptwebcomponents.github.io/myscript-math

@demo demo/index.html Basic Demo
-->
<dom-module id="myscript-math">
    <style>
        :host {
            display: block;
        }

        paper-toolbar {
            --paper-toolbar-background: #00a7cf;
        }

        /*calc from paper-toolbar height*/
        myscript-ink-paper {
            height: calc(100% - 64px);
        }

        @media (max-width: 639px) {
            myscript-ink-paper {
                height: calc(100% - 56px);
            }
        }
    </style>
    <template>
        <myscript-result></myscript-result>
        <paper-toolbar>
            <paper-icon-button id="delete" icon="delete"
                               on-tap="_delete">
            </paper-icon-button>
            <paper-icon-button id="undo" icon="undo"
                               on-tap="_undo" disabled="{{!hasUndo}}">
            </paper-icon-button>
            <paper-icon-button id="redo" icon="redo"
                               on-tap="_redo" disabled="{{!hasRedo}}">
            </paper-icon-button>
            <span class="flex"></span>
            <paper-icon-button id="info" icon="info"
                               on-tap="_info">
            </paper-icon-button>
        </paper-toolbar>
        <paper-dialog id="infodialog" modal>
            <h3>About</h3>

            <p align='justify'>Write an equation in the canvas zone. <br> After a short timeout (a second) the
                recognition will be launched and the result will be shown on the result field. <br> You
                can clear the writing space by clicking on the garbage can icon in the top left corner.</p>

            <div class="buttons">
                <paper-button dialog-confirm autofocus>Close</paper-button>
            </div>
        </paper-dialog>
        <myscript-ink-paper host="{{ host }}"
                            protocol="{{ protocol }}"
                            type="MATH"
                            application-key="{{ applicationkey }}"
                            hmac-key="{{ hmackey }}"
                            timeout="{{ timeout }}"
                            on-changed="_onChanged"
                            on-success="_onSuccess"
                            on-failure="_onFailure">
        </myscript-ink-paper>
        <paper-toast id="error"></paper-toast>
    </template>
</dom-module>

<script>
    (function () {
        Polymer({
            is: 'myscript-math',
            /**
             * Fired when a LaTeX recognition result is successfully received.
             *
             * @event latex
             */
            /**
             * Fired when a MathML recognition result is successfully received.
             *
             * @event mathml
             */
            /**
             * Fired when a SymbolTree recognition result is successfully received.
             *
             * @event symboltree
             */
            /**
             * Fired when the content of the InkPaper changes.
             *
             * @event changed
             */
            properties: {
                /**
                 * The current recognition protocol (e.g. REST, or WebSocket <b>ONLY</b> for TEXT and MATH)
                 *
                 * @private
                 * @attribute protocol
                 * @type String
                 * @default 'REST'
                 */
                protocol: {
                    type: String,
                    notify: true,
                    value: 'WebSocket'
                },
                /**
                 * The current recognition service host
                 *
                 * @private
                 * @attribute host
                 * @type String
                 * @default 'cloud.myscript.com'
                 */
                host: {
                    type: String,
                    notify: true
                },
                /**
                 * Recognition timeout
                 *
                 * @private
                 * @attribute timeout
                 * @type Number
                 * @default 2000
                 */
                timeout: {
                    type: Number,
                    notify: true
                },
                /**
                 * Application key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own MyScript Developer account at http://dev.myscript.com and then generate your application key at http://cloud.myscript.com.<br>
                 * <b>Warning</b>: This parameter is <b>mandatory</b> and it's value should be a string.
                 *
                 * @attribute application-key
                 * @type String
                 */
                applicationkey: {
                    type: String,
                    notify: true
                },
                /**
                 * HMAC key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own HMAC key corresponding to your own application key in your account at http://cloud.myscript.com.<br>
                 *
                 * <b>Warning</b>: This parameter may be <b>mandatory</b> if HMAC signature security is enable for your application. The value should be a string.
                 *
                 * @attribute hmac-key
                 * @type String
                 */
                hmackey: {
                    type: String,
                    notify: true
                },
                /**
                 * @private
                 * @attribute has-undo
                 * @type Boolean
                 */
                hasUndo: {
                    type: Boolean,
                    notify: true,
                    value: false
                },
                /**
                 * @private
                 * @attribute has-redo
                 * @type Boolean
                 */
                hasRedo: {
                    type: String,
                    notify: true,
                    value: false
                }
            },
            _delete: function () {
                this._inkPaper.clear();
                //this._myscriptResult.setResult("");
                this.fire('result');
            },
            _undo: function () {
                this._inkPaper.undo();
            },
            _redo: function () {
                this._inkPaper.redo();
            },
            _info: function () {
                this.$.infodialog.toggle();
            },
            _recognize: function () {
                this._inkPaper.recognize();
            },
            _onRecognized: function (e) {
                this.fire(e.type, e.detail);
            },
            _onError: function (e) {
                this.fire(e.type, e.detail);
            },
            _onChanged: function (e) {
                if (e.detail) {
                    this.hasUndo = e.detail.hasUndo;
                    this.hasRedo = e.detail.hasRedo;
                }
                this.fire(e.type, e.detail);
            },

            /**
             * Recognition success listener
             *
             * @private
             * @method _onSuccess
             */
            _onSuccess: function (e) {

                var result = e.detail;
                this.fire('result', result);
                //this.fire(e.type, e.detail);
                this._result.setResult(result);

            },
            /**
             * Failure listener
             *
             * @private
             * @method _onFailure
             */
            _onFailure: function (e) {
                this.fire('error', e.detail);
                this.fire(e.type, e.detail);
                this._paperToast.text = (typeof e.detail === 'object') ? JSON.stringify(e.detail) : e.detail;
                this._paperToast.show();
            },
            ready: function () {
                this._inkPaper = this.querySelector('myscript-ink-paper');
                this._paperToast = this.querySelector('paper-toast');
                this._result = this.querySelector('myscript-result');
            }
        });

    })();
</script>
