<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../myscript-toolbar/myscript-toolbar.html">
<link rel="import" href="../myscript-result/myscript-result.html">
<link rel="import" href="../myscript-ink-manager/myscript-ink-manager.html">
<link rel="import" href="../myscript-renderer/myscript-renderer.html">
<link rel="import" href="../myscript-recognizer/myscript-recognizer.html">
<link rel="import" href="../myscript-canvas/myscript-canvas.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-progress/paper-progress.html">

<!--
`myscript-math` is a turnkey solution for those who need to add quickly MyScript Math recognition.<br>
`myscript-math` is what we call a rich component.<br>
It contains several MyScript Elements like `myscript-result`, `myscript-toolbar`, `myscript-ink-manager`, `myscript-recognizer` and `myscript-canvas`.

##### Example

    <myscript-math url="cloud.myscript.com" applicationKey="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" hmacKey="XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX"></myscript-math>

@group MyScript Elements
@element myscript-math
@blurb MyScript HTML5 Math Element to help developers integrate math handwriting recognition.
@status alpha
@homepage http://polymerlabs.github.io/myscript-math
-->
<polymer-element name="myscript-math">
    <template>
        <link rel="stylesheet" href="./myscript-math.css">
        <div flex>
            <core-header-panel navigation flex>
                <paper-progress  class="myscript"></paper-progress>
                <myscript-result></myscript-result>
                <myscript-toolbar delete="true" undo="true" redo="true" info="true"></myscript-toolbar>
            </core-header-panel>
            <myscript-ink-manager></myscript-ink-manager>
            <myscript-renderer type="{{type}}"></myscript-renderer>
            <myscript-recognizer url="{{url}}" applicationKey="{{applicationKey}}" hmacKey="{{hmacKey}}" type="{{type}}"></myscript-recognizer>
            <myscript-canvas></myscript-canvas>
            <paper-dialog id="infodialog" class="infodialog" backdrop layout fullbleed>
                <div class="fullcontainer" fullbleed flex layout vertical>
                    <h3>About</h3>

                    <p align='justify'>Write an equation in the canvas zone. <br> After a short timeout (a second) the
                        recognition will be launched and the result will be shown at the bottom of the page. <br> You
                        can clear the writing space by clicking on the garbage can icon in the top right corner of the
                        yellow zone.</p>
                </div>
            </paper-dialog>
        </div>
    </template>
    <script>
        Polymer('myscript-math', {

            publish: {

                /**
                 * Url to use for MyScript handwriting recognition server
                 *
                 * @attribute url
                 * @type string
                 * @default 'cloud.myscript.com'
                 */
                url: 'cloud.myscript.com',

                /**
                 * Application key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own in your account at http://cloud.myscript.com
                 *
                 * @attribute applicationKey
                 * @type string
                 * @default 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'
                 */
                applicationKey: 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX',

                /**
                 * Hmac key to use for recognition on MyScript handwriting recognition server.<br>
                 * You have to create your own hmac key corresponding to your own application key in your account at http://cloud.myscript.com
                 *
                 * @attribute hmacKey
                 * @type string
                 * @default 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'
                 */
                hmacKey: 'XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX'

            },

            // Handle event of myscript element
            eventDelegates: {
                'myscript-toolbar-delete': 'delete',
                'myscript-toolbar-undo': 'undo',
                'myscript-toolbar-redo': 'redo',
                'myscript-toolbar-info': 'info',
                'myscript-canvas-down': 'down',
                'myscript-canvas-track': 'track',
                'myscript-canvas-up': 'up',
                'myscript-canvas-resize': 'redraw'
            },

            // Handwriting recogntion type
            type: 'Math',

            // myscript-result element
            result: undefined,

            // myscript-toolbar element
            toolbar: undefined,

            // myscript-ink-manager element
            inkManager: undefined,

            // myscript-renderer element
            renderer: undefined,

            // myscript-recognizer element
            recognizer: undefined,

            // myscript-canvas element
            canvas: undefined,

            // paper-progress element
            progress: undefined,

            // Instance ID of Math handwriting recognition
            instanceId: undefined,

            // Input component to recognize
            components: [],

            // Job use for Math handwriting recognition process
            timer: undefined,

            delete: function (event) {
                this.result.clear();
                this.inkManager.clear();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.instanceId = '';
                this.progress.indeterminate = false;
            },
            undo: function (event) {
                this.inkManager.undo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.inkManager.getStrokes(), this.canvas.$.canvas.getContext('2d'));
            },
            redo: function (event) {
                this.inkManager.redo();
                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                this.renderer.drawStrokes(this.inkManager.getStrokes(), this.canvas.$.canvas.getContext('2d'));
            },
            info: function (event) {
                this.$.infodialog.toggle();
            },
            down: function (event) {
                if (this.timer) {
                    this.timer.stop();
                    this.progress.indeterminate = false;
                }
                this.inkManager.startInkCapture(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop, event.detail.timeStamp);
                this.renderer.drawStart(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop);
            },
            track: function (event) {
                this.inkManager.continueInkCapture(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop, event.detail.timeStamp);
                this.renderer.drawContinue(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop, this.canvas.$.canvas.getContext('2d'));
            },
            up: function (event) {
                this.inkManager.endInkCapture(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop, event.detail.timeStamp);
                this.renderer.drawEnd(event.detail.pageX - event.detail.currentTarget.offsetLeft, event.detail.pageY - event.detail.currentTarget.offsetTop, this.canvas.$.canvas.getContext('2d'));

                this.timer = this.job(this.timer, function () {
                    this.progress.indeterminate = true;
                    this.recognizer.doSimpleRecognition(this.instanceId, this.components.concat(this.inkManager.getStrokes())).then(
                            function success (response) {
                                this.progress.indeterminate = false;
                                this.result.setResult(response);
                                this.instanceId = response.instanceId;
                                this.renderer.clear(this.canvas.$.canvas.getContext('2d'));
                                this.renderer.drawRecognitionResult(this.inkManager.getStrokes(), response.result, this.canvas.$.canvas.getContext('2d'));
                            }.bind(this),
                            function error (response) {
                                this.progress.indeterminate = false;
                                this.result.setResult(JSON.stringify(response));
                            }.bind(this)
                    );
                }, 2000);
            },
            redraw: function () {
                if (typeof this.result.getResult() !== "string") {
                    this.renderer.drawRecognitionResult(this.inkManager.getStrokes(), this.result.getResult().result, this.canvas.$.canvas.getContext('2d'));
                } else {
                    this.renderer.drawStrokes(this.inkManager.getStrokes(), this.canvas.$.canvas.getContext('2d'));
                }
            },
            ready: function () {

                this.result = this.shadowRoot.querySelector('myscript-result');
                this.toolbar = this.shadowRoot.querySelector('myscript-toolbar');
                this.inkManager = this.shadowRoot.querySelector('myscript-ink-manager');
                this.renderer = this.shadowRoot.querySelector('myscript-renderer');
                this.recognizer = this.shadowRoot.querySelector('myscript-recognizer');
                this.canvas = this.shadowRoot.querySelector('myscript-canvas');
                this.progress = this.shadowRoot.querySelector('paper-progress');

                this.instanceId = '';
                this.components = [];

            }
        });
    </script>
</polymer-element>